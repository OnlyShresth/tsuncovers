<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tsun — It's not like I archived these for you</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&family=DM+Mono:wght@300;400&display=swap"
    rel="stylesheet">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root {
      --bg: #0a0a0a;
      --surface: #111111;
      --surface2: #1a1a1a;
      --border: #2a2a2a;
      --text: #e8e4dc;
      --muted: #6b6560;
      --accent: #c9a96e;
      --accent2: #8b5e3c;
      --danger: #9b4040;
      --blush: #c97070;
      --card-shadow: 0 4px 24px rgba(0, 0, 0, 0.6);
      --radius: 3px;
      --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    [data-theme="light"] {
      --bg: #f5f0e8;
      --surface: #ede8df;
      --surface2: #e5dfd4;
      --border: #cfc8bc;
      --text: #1a1714;
      --muted: #8a8278;
      --accent: #8b5e2c;
      --accent2: #c9a96e;
      --danger: #9b4040;
      --blush: #c97070;
      --card-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'DM Mono', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      font-size: 13px;
      line-height: 1.6;
      transition: background var(--transition), color var(--transition);
    }

    /* HEADER */
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid var(--border);
      padding: 0 2rem;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(12px);
      background: color-mix(in srgb, var(--bg) 90%, transparent);
    }

    .logo {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.8rem;
      font-weight: 300;
      letter-spacing: 0.15em;
      color: var(--accent);
      text-decoration: none;
      display: flex;
      align-items: baseline;
      gap: 2px;
    }

    .logo span {
      color: var(--text);
      font-style: italic;
    }

    .logo-blush {
      font-size: 10px;
      letter-spacing: 0.08em;
      color: var(--blush);
      font-family: 'DM Mono', monospace;
      font-style: normal;
      opacity: 0.7;
      margin-left: 6px;
      align-self: center;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .theme-toggle {
      background: none;
      border: 1px solid var(--border);
      color: var(--muted);
      cursor: pointer;
      padding: 6px 12px;
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      letter-spacing: 0.1em;
      transition: all var(--transition);
      text-transform: uppercase;
    }

    .theme-toggle:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* HERO */
    .hero {
      padding: 5rem 2rem 3rem;
      max-width: 900px;
      margin: 0 auto;
      text-align: center;
      position: relative;
      z-index: 50;
    }

    .hero-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: clamp(2.5rem, 6vw, 5rem);
      font-weight: 300;
      line-height: 1;
      letter-spacing: -0.02em;
      margin-bottom: 0.5rem;
    }

    .hero-title em {
      font-style: italic;
      color: var(--accent);
    }

    .hero-sub {
      color: var(--muted);
      letter-spacing: 0.12em;
      text-transform: uppercase;
      font-size: 11px;
      margin-bottom: 2.5rem;
    }

    .hero-disclaimer {
      color: var(--blush);
      font-size: 10px;
      letter-spacing: 0.1em;
      margin-top: -1.8rem;
      margin-bottom: 2rem;
      opacity: 0.8;
      font-style: italic;
    }

    .search-wrap {
      position: relative;
      max-width: 560px;
      margin: 0 auto;
      z-index: 20;
    }

    .search-input {
      width: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 14px;
      padding: 14px 50px 14px 20px;
      outline: none;
      transition: border-color var(--transition);
      letter-spacing: 0.05em;
    }

    .search-input::placeholder {
      color: var(--muted);
    }

    .search-input:focus {
      border-color: var(--accent);
    }

    .search-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      pointer-events: none;
      font-size: 16px;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      z-index: 200;
      max-height: 320px;
      overflow-y: auto;
      display: none;
      box-shadow: var(--card-shadow);
    }

    .autocomplete-dropdown.open {
      display: block;
    }

    .autocomplete-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      cursor: pointer;
      transition: background var(--transition);
      border-bottom: 1px solid var(--border);
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-item:hover,
    .autocomplete-item.active {
      background: var(--surface2);
    }

    .autocomplete-thumb {
      width: 32px;
      height: 44px;
      object-fit: cover;
      flex-shrink: 0;
      background: var(--surface2);
    }

    .autocomplete-info .name {
      color: var(--text);
      font-size: 13px;
      display: block;
    }

    .autocomplete-info .meta {
      color: var(--muted);
      font-size: 11px;
      letter-spacing: 0.05em;
    }

    /* MANGA META CARD */
    .manga-meta {
      max-width: 1200px;
      margin: 0 auto 2rem;
      padding: 0 2rem;
      display: none;
      animation: fadeUp 0.3s ease;
    }

    .manga-meta.visible {
      display: flex;
      gap: 2rem;
      align-items: flex-start;
    }

    .meta-cover {
      width: 120px;
      flex-shrink: 0;
    }

    .meta-cover img {
      width: 100%;
      box-shadow: var(--card-shadow);
    }

    .meta-info {
      flex: 1;
    }

    .meta-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2.2rem;
      font-weight: 300;
      line-height: 1.1;
      margin-bottom: 0.5rem;
    }

    .meta-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 1rem;
    }

    .tag {
      font-size: 10px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      padding: 3px 8px;
      border: 1px solid var(--border);
      color: var(--muted);
    }

    .tag.accent {
      border-color: var(--accent);
      color: var(--accent);
    }

    .meta-synopsis {
      color: var(--muted);
      font-size: 12px;
      line-height: 1.8;
      max-width: 600px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .meta-tsun-comment {
      margin-top: 0.6rem;
      color: var(--blush);
      font-size: 10px;
      letter-spacing: 0.08em;
      font-style: italic;
      opacity: 0.9;
    }

    .meta-actions {
      margin-top: 1.2rem;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 8px 18px;
      cursor: pointer;
      border: 1px solid var(--border);
      background: none;
      color: var(--text);
      transition: all var(--transition);
    }

    .btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #0a0a0a;
    }

    .btn.primary:hover {
      background: transparent;
      color: var(--accent);
    }

    .btn.danger {
      border-color: var(--danger);
      color: var(--danger);
    }

    .btn.danger:hover {
      background: var(--danger);
      color: white;
    }

    .selection-count {
      color: var(--muted);
      font-size: 11px;
      letter-spacing: 0.1em;
    }

    /* GALLERY */
    .gallery-section {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 2rem 4rem;
      display: none;
    }

    .gallery-section.visible {
      display: block;
    }

    .gallery-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .gallery-label {
      font-size: 11px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .gallery-label span {
      color: var(--accent);
    }

    .covers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
    }

    .cover-card {
      position: relative;
      cursor: pointer;
      animation: fadeUp 0.3s ease both;
    }

    .cover-card img {
      width: 100%;
      aspect-ratio: 2/3;
      object-fit: cover;
      display: block;
      transition: transform var(--transition), box-shadow var(--transition);
      background: var(--surface);
    }

    .cover-card:hover img {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
    }

    .cover-card.selected img {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .cover-select-badge {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      background: var(--bg);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      opacity: 0;
      transition: opacity var(--transition);
      color: var(--muted);
    }

    .cover-card:hover .cover-select-badge,
    .cover-card.selected .cover-select-badge {
      opacity: 1;
    }

    .cover-card.selected .cover-select-badge {
      background: var(--accent);
      border-color: var(--accent);
      color: #0a0a0a;
    }

    .cover-vol {
      margin-top: 6px;
      font-size: 10px;
      letter-spacing: 0.1em;
      color: var(--muted);
      text-align: center;
      text-transform: uppercase;
    }

    .load-more-wrap {
      text-align: center;
      margin-top: 2rem;
    }

    /* SELECTION TOOLBAR */
    .selection-toolbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--accent);
      padding: 14px 2rem;
      display: none;
      align-items: center;
      justify-content: space-between;
      z-index: 300;
      animation: slideUp 0.25s ease;
    }

    .selection-toolbar.visible {
      display: flex;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .toolbar-count {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.4rem;
      font-weight: 300;
      color: var(--accent);
    }

    .toolbar-label {
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .grid-preview {
      display: grid;
      grid-template-columns: repeat(3, 24px);
      grid-template-rows: repeat(3, 24px);
      gap: 2px;
      opacity: 0.6;
    }

    .grid-preview-cell {
      background: var(--border);
      transition: background var(--transition);
    }

    .grid-preview-cell.filled {
      background: var(--accent);
    }

    /* LIGHTBOX */
    .lightbox {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.92);
      z-index: 500;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .lightbox.open {
      display: flex;
    }

    .lightbox-inner {
      position: relative;
      max-width: 400px;
      width: 100%;
      user-select: none;
    }

    .lightbox-img {
      width: 100%;
      max-height: 80vh;
      object-fit: contain;
      display: block;
      box-shadow: 0 20px 80px rgba(0, 0, 0, 0.8);
      touch-action: pan-y;
    }

    .lightbox-info {
      position: absolute;
      bottom: -2.5rem;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 11px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.5);
    }

    .lightbox-nav {
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.6);
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      transition: all var(--transition);
      z-index: 501;
    }

    .lightbox-nav:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .lightbox-nav.prev {
      left: 1.5rem;
    }

    .lightbox-nav.next {
      right: 1.5rem;
    }

    .lightbox-close {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      background: none;
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: rgba(255, 255, 255, 0.6);
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      transition: all var(--transition);
      z-index: 501;
    }

    .lightbox-close:hover {
      border-color: var(--blush);
      color: var(--blush);
    }

    /* GRID MODAL */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 600;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      /* Prevent modal from hogging screen */
      overflow-y: auto;
      /* Allow scrolling within modal */
      padding: 2rem;
      animation: fadeUp 0.25s ease;
      position: relative;
      /* For close button positioning */
    }

    .modal-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.6rem;
      font-weight: 300;
      margin-bottom: 0.3rem;
    }

    .modal-sub {
      color: var(--muted);
      font-size: 11px;
      letter-spacing: 0.1em;
      margin-bottom: 1.5rem;
      font-style: italic;
    }

    .grid-canvas-wrap {
      width: 100%;
      background: #000;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }

    #gridCanvas {
      width: 100%;
      height: auto;
      display: block;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    /* DIVIDER */
    .section-divider {
      max-width: 1200px;
      margin: 3rem auto;
      padding: 0 2rem;
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .divider-label {
      font-size: 11px;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--muted);
      white-space: nowrap;
    }

    .divider-sub {
      font-size: 10px;
      color: var(--blush);
      font-style: italic;
      white-space: nowrap;
    }

    .divider-line {
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* GENRE SECTION */
    .genre-section {
      max-width: 1200px;
      margin: 0 auto 4rem;
      padding: 0 2rem;
    }

    .genre-block {
      margin-bottom: 3rem;
    }

    .genre-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 1.2rem;
    }

    .genre-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      font-weight: 300;
      letter-spacing: 0.05em;
    }

    .genre-title-sub {
      font-size: 10px;
      color: var(--blush);
      letter-spacing: 0.08em;
      font-style: italic;
      margin-left: 10px;
      font-family: 'DM Mono', monospace;
      font-weight: 300;
    }

    .genre-nav {
      display: flex;
      gap: 6px;
    }

    .genre-nav-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--muted);
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      transition: all var(--transition);
    }

    .genre-nav-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .carousel-container {
      position: relative;
    }

    .carousel-container:hover .nav-btn {
      opacity: 1;
    }

    .nav-btn {
      position: absolute;
      top: 55%;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      font-family: 'DM Mono', monospace;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      opacity: 0;
      transition: all 0.2s ease;
      backdrop-filter: blur(4px);
    }

    .nav-btn:hover {
      background: var(--accent);
      color: black;
    }

    .nav-btn.prev {
      left: -16px;
    }

    .nav-btn.next {
      right: -16px;
    }

    .genre-carousel {
      display: flex;
      gap: 14px;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      padding-bottom: 1rem;
      scrollbar-width: none;
      scroll-behavior: smooth;
    }

    .genre-carousel::-webkit-scrollbar {
      display: none;
    }

    .genre-card {
      flex-shrink: 0;
      width: 140px;
      scroll-snap-align: start;
      cursor: pointer;
      transition: opacity var(--transition);
    }

    .genre-card:hover {
      opacity: 0.85;
    }

    .genre-card img {
      width: 100%;
      aspect-ratio: 2/3;
      object-fit: cover;
      display: block;
      background: var(--surface);
      box-shadow: var(--card-shadow);
      transition: transform var(--transition);
    }

    .genre-card:hover img {
      transform: translateY(-4px);
    }

    .genre-card-title {
      margin-top: 8px;
      font-size: 11px;
      letter-spacing: 0.05em;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .genre-card-score {
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
      letter-spacing: 0.05em;
    }

    .genre-card-score .star {
      color: var(--accent);
    }

    /* LOADING */
    .loading-ring {
      width: 32px;
      height: 32px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 3rem auto;
      display: none;
    }

    .loading-ring.visible {
      display: block;
    }

    .loading-caption {
      text-align: center;
      color: var(--blush);
      font-size: 11px;
      letter-spacing: 0.1em;
      font-style: italic;
      margin-top: -2rem;
      margin-bottom: 2rem;
      display: none;
    }

    .loading-caption.visible {
      display: block;
    }

    .skeleton {
      background: linear-gradient(90deg, var(--surface) 25%, var(--surface2) 50%, var(--surface) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.4s infinite;
    }

    .skeleton-card {
      width: 140px;
      aspect-ratio: 2/3;
      background: var(--surface2);
      flex-shrink: 0;
      scroll-snap-align: start;
      border-radius: var(--radius);
      animation: pulse 1.5s infinite ease-in-out;
    }

    @keyframes pulse {
      0% {
        opacity: 0.6;
      }

      50% {
        opacity: 0.8;
      }

      100% {
        opacity: 0.6;
      }
    }

    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--muted);
      display: none;
    }

    .empty-state.visible {
      display: block;
    }

    .empty-state-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 300;
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    .empty-state-sub {
      color: var(--blush);
      font-style: italic;
      font-size: 12px;
      margin-top: 0.5rem;
    }

    /* NOTIFICATION */
    .notif {
      position: fixed;
      top: 70px;
      right: 2rem;
      background: var(--surface);
      border: 1px solid var(--accent);
      color: var(--text);
      padding: 10px 16px;
      font-size: 11px;
      letter-spacing: 0.1em;
      z-index: 999;
      animation: slideInRight 0.25s ease, fadeOut 0.3s ease 2.5s both;
      pointer-events: none;
    }

    .notif.blush {
      border-color: var(--blush);
    }

    /* ANIMATIONS */
    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(16px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }

      to {
        transform: translateY(0);
      }
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes fadeOut {
      to {
        opacity: 0;
      }
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    @keyframes heroPulse {

      0%,
      100% {
        opacity: 0.7;
        transform: scale(1);
      }

      50% {
        opacity: 1;
        transform: scale(1.015);
      }
    }

    @keyframes notifOut {
      to {
        transform: translateX(120%);
        opacity: 0;
      }
    }

    @keyframes modalPop {
      from {
        opacity: 0;
        transform: scale(0.93) translateY(12px);
      }

      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    @keyframes toolbarSlide {
      from {
        transform: translateY(100%);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* HEADER SCROLL SHADOW */
    header {
      transition: box-shadow 0.3s ease;
    }

    header.scrolled {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.35);
    }

    /* HERO ENHANCED */
    .hero {
      animation: fadeUp 0.5s ease both;
    }

    .hero-title {
      animation: fadeUp 0.5s ease 0.05s both;
    }

    .hero-sub {
      animation: fadeUp 0.5s ease 0.1s both;
    }

    .hero-disclaimer {
      animation: fadeUp 0.5s ease 0.15s both;
    }

    .search-wrap {
      animation: fadeUp 0.5s ease 0.2s both;
    }

    /* MANGA META CARD ANIMATION */
    .manga-meta.visible {
      animation: fadeUp 0.35s ease both;
    }

    .meta-cover img {
      transition: transform 0.4s ease, box-shadow 0.3s ease;
    }

    .meta-cover img:hover {
      transform: translateY(-4px) rotate(-1deg);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.5);
    }

    /* COVER CARDS — staggered reveal */
    .cover-card {
      animation: fadeUp 0.3s ease both;
    }

    .cover-card:hover img {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 16px 36px rgba(0, 0, 0, 0.55);
    }

    /* SELECTION TOOLBAR */
    .selection-toolbar.visible {
      animation: toolbarSlide 0.3s cubic-bezier(0.34, 1.4, 0.64, 1);
    }

    /* GRID MODAL POP */
    .modal-overlay.open .modal {
      animation: modalPop 0.28s cubic-bezier(0.34, 1.4, 0.64, 1);
    }

    /* LIGHTBOX FADE */
    .lightbox {
      backdrop-filter: blur(8px);
      transition: background 0.2s ease;
    }

    .lightbox.open {
      animation: fadeIn 0.2s ease;
    }

    /* GENRE CARD HOVER */
    .genre-card {
      transition: opacity var(--transition), transform 0.25s ease;
    }

    .genre-card:hover {
      opacity: 1;
      transform: translateY(-4px);
    }

    /* CLOSE BUTTON ROTATE */
    button.lightbox-close,
    button.modal-close {
      transition: color var(--transition), transform var(--transition);
    }

    button.lightbox-close:hover {
      transform: rotate(90deg);
    }

    /* NOTIF OUT */
    .notif.leaving {
      animation: notifOut 0.25s ease forwards;
    }

    /* SEARCH SPINNER */
    .search-spinner {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      display: none;
      pointer-events: none;
    }

    .search-spinner.visible {
      display: block;
    }

    /* ERROR STATES */
    .fetch-error {
      text-align: center;
      padding: 2rem;
      color: var(--blush);
      font-size: 11px;
      font-style: italic;
      letter-spacing: 0.08em;
      animation: fadeUp 0.25s ease;
    }

    .fetch-error .retry-btn {
      display: inline-block;
      margin-top: 0.8rem;
      padding: 6px 14px;
      border: 1px solid var(--blush);
      color: var(--blush);
      background: none;
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all var(--transition);
    }

    .fetch-error .retry-btn:hover {
      background: var(--blush);
      color: var(--bg);
    }

    /* BUILD 3x3 BUTTON SHIMMER WHEN READY */
    #buildGridBtn:not(:disabled) {
      animation: shimmerBtn 2.5s ease infinite;
    }

    @keyframes shimmerBtn {

      0%,
      100% {
        box-shadow: none;
      }

      50% {
        box-shadow: 0 0 16px color-mix(in srgb, var(--accent) 40%, transparent);
      }
    }

    /* RESPONSIVE */
    @media (max-width: 640px) {
      .hero {
        padding: 3rem 1.2rem 2rem;
      }

      .hero-title {
        font-size: clamp(2rem, 8vw, 2.8rem);
      }

      .manga-meta.visible {
        flex-direction: column;
        padding: 0 1.2rem;
        gap: 1rem;
      }

      .meta-cover {
        width: 90px;
      }

      .meta-title {
        font-size: 1.6rem;
      }

      .gallery-section,
      .genre-section {
        padding: 0 1.2rem 3rem;
      }

      .covers-grid {
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        gap: 8px;
      }

      .lightbox-nav {
        display: none;
      }

      .selection-toolbar {
        padding: 12px 1.2rem;
        flex-wrap: wrap;
        gap: 8px;
      }

      .selection-toolbar>div {
        width: 100%;
        justify-content: space-between;
      }

      .genre-card {
        width: 110px;
      }

      header {
        padding: 0 1.2rem;
      }

      .logo {
        font-size: 1.3rem;
      }

      .logo-blush {
        display: none;
      }

      .toolbar-hint {
        display: none;
      }

      .gallery-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
    }

    @media (max-width: 420px) {
      .covers-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
      }

      .genre-card {
        width: 95px;
      }

      .meta-actions {
        gap: 6px;
      }

      .btn {
        padding: 7px 12px;
        font-size: 10px;
      }
    }

    @media (min-width: 1400px) {
      .covers-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      }
    }

    ::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--muted);
    }

    #offscreenCanvas {
      display: none;
    }
  </style>
</head>

<body>

  <header id="siteHeader">
    <a class="logo" href="index.html">Ts<span>un</span><span class="logo-blush">...it's not like I made this for
        you</span></a>
    <div class="header-right">
      <a href="builder.html"
        style="font-family:'DM Mono',monospace;font-size:11px;letter-spacing:0.1em;text-transform:uppercase;border:1px solid var(--border);color:var(--muted);padding:6px 12px;text-decoration:none;transition:all var(--transition);"
        id="builderLink">3×3 Builder</a>
      <button class="theme-toggle" id="themeToggle">Too bright</button>
    </div>
  </header>
  <style>
    #builderLink:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    #siteHeader {
      transition: box-shadow 0.3s ease;
    }
  </style>

  <section class="hero">
    <h1 class="hero-title">It's not like I<br><em>saved these for you.</em></h1>
    <p class="hero-sub">I just happened to archive every manga cover ever. Don't read into it.</p>
    <p class="hero-disclaimer">...b-baka. Just search already.</p>
    <div class="search-wrap">
      <input type="text" class="search-input" id="searchInput" placeholder="Fine. Type a manga title, I guess..."
        autocomplete="off" spellcheck="false">
      <span class="search-icon" id="searchIconEl">&#x2315;</span>
      <div class="search-spinner" id="searchSpinnerEl"></div>
      <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
    </div>
  </section>

  <div class="manga-meta" id="mangaMeta">
    <div class="meta-cover">
      <img id="metaCoverImg" src="" alt="">
    </div>
    <div class="meta-info">
      <h2 class="meta-title" id="metaTitle"></h2>
      <div class="meta-tags" id="metaTags"></div>
      <p class="meta-synopsis" id="metaSynopsis"></p>
      <p class="meta-tsun-comment" id="metaTsunComment"></p>
      <div class="meta-actions">
        <button class="btn" id="selectModeBtn">Pick covers, I suppose</button>
        <span class="selection-count" id="selectionCountLabel" style="display:none"></span>
      </div>
    </div>
  </div>

  <div id="galleryLoading" class="loading-ring"></div>
  <div id="loadingCaption" class="loading-caption">Fetching covers... not because you asked. Just because.</div>

  <section class="gallery-section" id="gallerySection">
    <div class="gallery-header">
      <span class="gallery-label" id="galleryLabel">finding covers...</span>
    </div>
    <div class="covers-grid" id="coversGrid"></div>
    <div class="load-more-wrap" id="loadMoreWrap" style="display:none">
      <button class="btn" id="loadMoreBtn">There's more. Not that I'm excited to show you.</button>
    </div>
  </section>

  <div class="empty-state" id="emptyState">
    <p class="empty-state-title">Nothing found.</p>
    <p>I looked everywhere, okay? Don't blame me.</p>
    <p class="empty-state-sub">...maybe try a different title. I-I'm only suggesting it for your sake.</p>
  </div>

  <div class="section-divider" id="genreDivider">
    <span class="divider-label">Top manga by genre</span>
    <div class="divider-line"></div>
    <span class="divider-sub">don't thank me</span>
  </div>

  <section class="genre-section" id="genreSection">
    <div id="genreBlocks"></div>
  </section>

  <div class="selection-toolbar" id="selectionToolbar">
    <div class="toolbar-left">
      <div>
        <div class="toolbar-count" id="toolbarCount">0</div>
        <div class="toolbar-label">chosen. happy now?</div>
      </div>
      <div class="grid-preview" id="gridPreview">
        <div class="grid-preview-cell" data-idx="0"></div>
        <div class="grid-preview-cell" data-idx="1"></div>
        <div class="grid-preview-cell" data-idx="2"></div>
        <div class="grid-preview-cell" data-idx="3"></div>
        <div class="grid-preview-cell" data-idx="4"></div>
        <div class="grid-preview-cell" data-idx="5"></div>
        <div class="grid-preview-cell" data-idx="6"></div>
        <div class="grid-preview-cell" data-idx="7"></div>
        <div class="grid-preview-cell" data-idx="8"></div>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <span class="toolbar-hint" style="font-size:10px;color:var(--muted);letter-spacing:0.1em">Pick exactly 9. I'm not
        flexible about this.</span>
      <button class="btn primary" id="buildGridBtn" disabled>Build 3x3</button>
      <button class="btn" id="openInBuilderBtn" disabled>Open in Builder</button>
      <button class="btn danger" id="clearSelectionBtn">Forget it</button>
    </div>
  </div>

  <div class="lightbox" id="lightbox">
    <button class="lightbox-close" id="lightboxClose">&#x2715;</button>
    <button class="lightbox-nav prev" id="lightboxPrev">&#x2039;</button>
    <div class="lightbox-inner">
      <img class="lightbox-img" id="lightboxImg" src="" alt="" draggable="false">
      <div class="lightbox-info" id="lightboxInfo"></div>
    </div>
    <button class="lightbox-nav next" id="lightboxNext">&#x203A;</button>
  </div>

  <div class="modal-overlay" id="gridModal">
    <div class="modal">
      <button class="modal-close" id="gridModalClose"
        style="position:absolute;top:1rem;right:1rem;background:none;border:none;color:var(--muted);font-size:24px;cursor:pointer;">&times;</button>
      <h2 class="modal-title">Your 3x3 Grid</h2>
      <p class="modal-sub">I made it for you. Don't get the wrong idea — it took two seconds.</p>
      <div class="grid-canvas-wrap">
        <canvas id="gridCanvas"></canvas>
      </div>
      <div class="modal-actions">
        <button class="btn" id="closeModal">Never mind</button>
        <button class="btn primary" id="downloadGrid">Take it. Fine.</button>
      </div>
    </div>
  </div>

  <canvas id="offscreenCanvas"></canvas>

  <script>
    // ===================== CONFIG =====================
    const GOOGLE_CLIENT_ID = '899850205404-mkpt9ti98akido6pghg7aed55309b8mt.apps.googleusercontent.com';
    const API_BASE_URL = 'https://tsuncovers.onrender.com';
    // ===================== TSUNDERE LINES =====================
    const TSUN_COMMENTS = {
      onLoad: ["...you came back. Whatever.", "I wasn't waiting for you.", "Don't assume I'm happy you're here."],
      onSearch: ["Fine, I'll look it up.", "I already knew you'd search for this.", "Fetching. Don't stare."],
      onCoversLoaded: ["There. Every cover. You're welcome.", "I found them all. Don't get used to it."],
      onSelect: ["Picking covers? What are you making...", "Fine. Build your little grid."],
      onDownload: ["You saved it. Good.", "Downloaded. Don't tell anyone I helped you."]
    };
    function tsunLine(category) {
      const lines = TSUN_COMMENTS[category];
      return lines[Math.floor(Math.random() * lines.length)];
    }
    const GENRE_TSUN = {
      'Action': "...fine. explosions.",
      'Romance': "d-don't look at me reading these",
      'Fantasy': "i like the world-building. that's all.",
      'Horror': "i'm not scared. you're scared.",
      'Comedy': "i didn't laugh. my face just did that."
    };

    // ===================== STATE =====================
    const state = {
      theme: 'dark', searchResults: [], currentManga: null, covers: [], displayedCovers: [],
      perPage: 50, page: 0, totalCovers: 0, selectedCovers: new Set(), selectMode: false,
      lightboxIndex: 0, genres: ['Action', 'Romance', 'Fantasy', 'Horror', 'Comedy'],
      searchTimeout: null, acIndex: -1
    };

    // ===================== DOM REFS =====================
    const $ = id => document.getElementById(id);
    const themeToggle = $('themeToggle');
    const searchInput = $('searchInput');
    const acDropdown = $('autocompleteDropdown');
    const mangaMeta = $('mangaMeta');
    const gallerySection = $('gallerySection');
    const galleryLoading = $('galleryLoading');
    const loadingCaption = $('loadingCaption');
    const coversGrid = $('coversGrid');
    const galleryLabel = $('galleryLabel');
    const loadMoreWrap = $('loadMoreWrap');
    const loadMoreBtn = $('loadMoreBtn');
    const emptyState = $('emptyState');
    const selectionToolbar = $('selectionToolbar');
    const toolbarCount = $('toolbarCount');
    const buildGridBtn = $('buildGridBtn');
    const clearSelectionBtn = $('clearSelectionBtn');
    const lightbox = $('lightbox');
    const lightboxImg = $('lightboxImg');
    const lightboxInfo = $('lightboxInfo');
    const lightboxClose = $('lightboxClose');
    const lightboxPrev = $('lightboxPrev');
    const lightboxNext = $('lightboxNext');
    const gridModal = $('gridModal');
    const gridCanvas = $('gridCanvas');
    const downloadGrid = $('downloadGrid');
    const closeModal = $('closeModal');
    const selectModeBtn = $('selectModeBtn');
    const selectionCountLabel = $('selectionCountLabel');
    const genreBlocks = $('genreBlocks');

    // ===================== THEME =====================
    themeToggle.addEventListener('click', () => {
      state.theme = state.theme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', state.theme);
      themeToggle.textContent = state.theme === 'dark' ? 'Too dark' : 'Too bright';
    });
    // Set initial text
    themeToggle.textContent = state.theme === 'dark' ? 'Too dark' : 'Too bright';

    // ===================== SEARCH =====================
    searchInput.addEventListener('input', () => {
      clearTimeout(state.searchTimeout);
      const q = searchInput.value.trim();
      if (q.length < 2) { closeDropdown(); return; }
      state.searchTimeout = setTimeout(() => fetchSuggestions(q), 380);
    });
    async function fetchSuggestions(query, autoSelect = false) {
      try {
        const url = `${API_BASE_URL || ''}/api/mangadex/manga?title=${encodeURIComponent(query)}&limit=8&order[relevance]=desc&contentRating[]=safe&contentRating[]=suggestive&contentRating[]=erotica&contentRating[]=pornographic&includes[]=cover_art`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('API Error');
        const data = await res.json();
        renderDropdown(data.data || []);
      } catch (e) {
        console.error(e);
      }
    }
    // Helper function to get manga title (prioritize English)
    function getMangaTitle(manga) {
      const titles = manga.attributes?.title || {};
      return titles.en || titles['ja-ro'] || titles.ja || Object.values(titles)[0] || 'Unknown Title';
    }

    // Helper function to build cover URL from MangaDex cover_art relationship
    function buildCoverUrl(manga) {
      if (!manga || !manga.id) return '';
      const coverRel = manga.relationships?.find(rel => rel.type === 'cover_art');
      if (coverRel?.attributes?.fileName) {
        return `https://uploads.mangadex.org/covers/${manga.id}/${coverRel.attributes.fileName}.512.jpg`;
      }
      return '';
    }

    function renderDropdown(results) {
      if (!results.length) { closeDropdown(); return; }
      acDropdown.innerHTML = results.map((m, i) => {
        const title = getMangaTitle(m);
        const coverUrl = buildCoverUrl(m);
        const isNSFW = m.attributes?.contentRating === 'pornographic';
        const titleStyle = isNSFW ? 'style="color: var(--blush);"' : '';
        return `
    <div class="autocomplete-item" data-idx="${i}">
      <img class="autocomplete-thumb" src="${coverUrl}" alt="">
      <div class="autocomplete-info"><span class="name" ${titleStyle}>${escHtml(title)}</span></div>
    </div>`;
      }).join('');
      acDropdown.classList.add('open');
      acDropdown.querySelectorAll('.autocomplete-item').forEach((el, i) => {
        el.addEventListener('click', () => selectManga(results[i]));
      });
    }
    function closeDropdown() { acDropdown.classList.remove('open'); }
    function escHtml(str) { return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;'); }

    // ===================== SELECT MANGA =====================
    async function selectManga(manga) {
      closeDropdown();
      const title = getMangaTitle(manga);
      searchInput.value = title;
      state.currentManga = manga;
      state.covers = [];
      state.displayedCovers = [];
      state.page = 0;
      state.selectedCovers.clear();
      state.selectMode = false;
      coversGrid.innerHTML = '';
      selectModeBtn.textContent = 'Pick covers, I suppose';
      updateSelectionUI();
      renderMeta(manga);
      showNotif(tsunLine('onSearch'), 'blush');
      await fetchCovers(manga);
    }

    function renderMeta(m) {
      const coverUrl = buildCoverUrl(m);
      const title = getMangaTitle(m);
      const isNSFW = m.attributes?.contentRating === 'pornographic';
      $('metaCoverImg').src = coverUrl;
      $('metaTitle').textContent = title;
      $('metaTitle').style.color = isNSFW ? 'var(--blush)' : '';
      // MangaDex tags are different structure - extract first 3 tags
      const tags = m.attributes?.tags || [];
      $('metaTags').innerHTML = tags.slice(0, 3).map(tag => `<span class="tag">${escHtml(tag.attributes?.name?.en || tag.attributes?.name || '')}</span>`).join('');
      $('metaSynopsis').textContent = m.attributes?.description?.en || m.attributes?.description?.['ja-ro'] || 'No synopsis.';
      $('metaTsunComment').textContent = "I've read this. Not saying I recommend it.";
      mangaMeta.classList.add('visible');
    }

    async function fetchCovers(manga) {
      gallerySection.classList.remove('visible');
      galleryLoading.classList.add('visible');
      try {
        // Fetch covers from MangaDex via proxy
        const res = await fetch(`${API_BASE_URL || ''}/api/mangadex/cover?manga[]=${manga.id}&limit=100&order[volume]=asc`);
        const data = await res.json();
        state.covers = (data.data || []).map((cover, i) => ({
          url: `https://uploads.mangadex.org/covers/${manga.id}/${cover.attributes.fileName}`,
          volume: cover.attributes.volume || cover.attributes.description || `Cover ${i + 1}`
        }));
        finishLoadingCovers();
      } catch (e) {
        galleryLoading.classList.remove('visible');
        showNotif("Nothing found.", 'blush');
      }
    }

    function finishLoadingCovers() {
      state.totalCovers = state.covers.length;
      galleryLoading.classList.remove('visible');
      gallerySection.classList.add('visible');
      galleryLabel.innerHTML = `&#x2014; <span>${state.totalCovers}</span> covers collected.`;
      renderNextPage();
    }

    function renderNextPage() {
      const start = state.page * state.perPage;
      const end = Math.min(start + state.perPage, state.covers.length);
      state.covers.slice(start, end).forEach((cover, idx) => {
        const absIdx = start + idx;
        const card = document.createElement('div');
        card.className = 'cover-card';
        card.innerHTML = `<div class="cover-select-badge">&#x2714;</div><img src="${cover.url}">`;
        card.addEventListener('click', () => {
          if (state.selectMode) toggleSelectCover(card, absIdx);
          else openLightbox(absIdx);
        });
        coversGrid.appendChild(card);
      });
      state.page++;
      loadMoreWrap.style.display = end < state.covers.length ? 'block' : 'none';
    }
    loadMoreBtn.addEventListener('click', renderNextPage);

    // ===================== SELECT MODE & BUILD =====================
    selectModeBtn.addEventListener('click', () => {
      state.selectMode = !state.selectMode;
      selectModeBtn.textContent = state.selectMode ? 'Stop picking' : 'Pick covers';
      if (!state.selectMode) { state.selectedCovers.clear(); updateSelectionUI(); }
    });

    clearSelectionBtn.addEventListener('click', () => {
      state.selectMode = false;
      selectModeBtn.textContent = 'Pick covers, I suppose';
      state.selectedCovers.clear();
      document.querySelectorAll('.cover-card.selected').forEach(card => card.classList.remove('selected'));
      updateSelectionUI();
    });

    function toggleSelectCover(card, idx) {
      if (state.selectedCovers.has(idx)) {
        state.selectedCovers.delete(idx);
        card.classList.remove('selected');
      } else {
        if (state.selectedCovers.size >= 9) { showNotif("9 is the limit.", 'blush'); return; }
        state.selectedCovers.add(idx);
        card.classList.add('selected');
      }
      updateSelectionUI();
    }

    function updateSelectionUI() {
      const count = state.selectedCovers.size;
      toolbarCount.textContent = count;
      buildGridBtn.disabled = count !== 9;
      // Open in Builder enabled if at least 1 is selected
      const openBtn = $('openInBuilderBtn');
      if (openBtn) openBtn.disabled = count === 0;

      selectionToolbar.classList.toggle('visible', count > 0);
      document.querySelectorAll('.grid-preview-cell').forEach((cell, i) => cell.classList.toggle('filled', i < count));
    }

    // ⚠️ PROXY FIX FOR INDEX PAGE
    buildGridBtn.addEventListener('click', async () => {
      if (state.selectedCovers.size !== 9) return;
      const indices = Array.from(state.selectedCovers).sort((a, b) => a - b);
      const urls = indices.map(i => state.covers[i].url);

      gridModal.classList.add('open');
      const canvas = gridCanvas;
      const ctx = canvas.getContext('2d');
      const size = 200, gap = 4;
      canvas.width = size * 3 + gap * 2;
      canvas.height = size * 1.5 * 3 + gap * 2;
      ctx.fillStyle = '#0a0a0a';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      const images = await Promise.all(urls.map(url => new Promise(resolve => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => resolve(img);
        img.onerror = () => resolve(null);
        // Use the backend proxy if available!
        if (API_BASE_URL && !API_BASE_URL.includes('localhost')) {
          img.src = `${API_BASE_URL}/api/proxy?url=${encodeURIComponent(url)}`;
        } else {
          img.src = url;
        }
      })));

      images.forEach((img, i) => {
        const col = i % 3, row = Math.floor(i / 3);
        if (img) ctx.drawImage(img, col * (size + gap), row * (size * 1.5 + gap), size, size * 1.5);
      });
    });

    $('openInBuilderBtn')?.addEventListener('click', () => {
      if (state.selectedCovers.size === 0) return;
      const indices = Array.from(state.selectedCovers).sort((a, b) => a - b);

      // Convert selection to Builder format
      const gridData = Array(9).fill(null);
      indices.forEach((coverIdx, i) => {
        if (i < 9) {
          gridData[i] = {
            id: state.currentManga.id,
            title: getMangaTitle(state.currentManga),
            image: state.covers[coverIdx].url
          };
        }
      });

      localStorage.setItem('tsun_current_grid', JSON.stringify(gridData));
      window.location.href = 'builder.html';
    });

    downloadGrid.addEventListener('click', () => {
      const link = document.createElement('a');
      link.download = `tsun-index-${Date.now()}.png`;
      link.href = gridCanvas.toDataURL('image/png');
      link.click();
    });

    closeModal.onclick = () => gridModal.classList.remove('open');
    $('gridModalClose').onclick = () => gridModal.classList.remove('open');

    // ===================== CAROUSEL LOGIC =====================
    const rotators = {};

    function scrollCarousel(g, dir) {
      const c = $(`cat-${g}`);
      if (c) c.scrollBy({ left: dir * 300, behavior: 'smooth' });
    }

    function initAutoRotate(g) {
      const container = $(`wrap-${g}`);
      const carousel = $(`cat-${g}`);
      if (!container || !carousel) return;

      const start = () => {
        if (rotators[g]) clearInterval(rotators[g]);
        rotators[g] = setInterval(() => {
          // If near end, scroll to start
          if (carousel.scrollLeft + carousel.clientWidth >= carousel.scrollWidth - 10) {
            carousel.scrollTo({ left: 0, behavior: 'smooth' });
          } else {
            carousel.scrollBy({ left: 154, behavior: 'smooth' }); // card width + gap
          }
        }, 3000);
      };

      const stop = () => {
        if (rotators[g]) clearInterval(rotators[g]);
      };

      container.addEventListener('mouseenter', stop);
      container.addEventListener('mouseleave', start);

      start();
    }

    // ===================== GENRES & INIT =====================
    async function loadGenres() {
      // 1. Render Skeletons & Structure
      for (const g of state.genres) {
        const block = document.createElement('div');
        block.innerHTML = `
          <h2 class="genre-title">${g}</h2>
          <div class="carousel-container" id="wrap-${g}">
            <button class="nav-btn prev" onclick="scrollCarousel('${g}', -1)">‹</button>
            <div class="genre-carousel" id="cat-${g}"></div>
            <button class="nav-btn next" onclick="scrollCarousel('${g}', 1)">›</button>
          </div>
        `;
        genreBlocks.appendChild(block);

        const carousel = $(`cat-${g}`);
        carousel.innerHTML = Array(10).fill('<div class="skeleton-card"></div>').join('');

        // Start rotation (works on skeletons too)
        initAutoRotate(g);
      }

      // 2. Progressive Fetching
      for (const g of state.genres) {
        await loadGenre(g);
      }
    }

    async function loadGenre(g) {
      const carousel = $(`cat-${g}`);
      // Using v2 cache key to invalidate old Jikan data after migration
      const cacheKey = `tsun_cache_v2_${g}`;

      // CACHE CHECK
      const cached = localStorage.getItem(cacheKey);
      if (cached) {
        try {
          const parsed = JSON.parse(cached);
          // 24h expiry check (optional, but good practice). Here just checking existence.
          if (Date.now() - parsed.ts < 24 * 60 * 60 * 1000) {
            renderCarouselItems(carousel, parsed.data);
            return;
          }
        } catch (e) { }
      }

      // FETCH: Batch 1 (Top 3 - Fast)
      // MangaDex tag UUIDs for genres
      const MANGADEX_TAGS = {
        'Action': '391b0423-d847-456f-aff0-8b0cfc03066b',
        'Romance': '423e2eae-a7a2-4a8b-ac03-a8351462d71d',
        'Fantasy': 'cdc58593-87dd-415e-bbc0-2ec27bf404cc',
        'Horror': 'cdad7e68-1419-41dd-bdce-27753074a640',
        'Comedy': '4d32cc48-9f00-4cca-9b5a-a839f0764984'
      };
      const tagId = MANGADEX_TAGS[g];

      try {
        const res1 = await fetch(`${API_BASE_URL || ''}/api/mangadex/manga?includedTags[]=${tagId}&limit=3&order[followedCount]=desc&contentRating[]=safe&contentRating[]=suggestive&contentRating[]=erotica&contentRating[]=pornographic&includes[]=cover_art`);
        if (res1.status === 429) throw new Error('Rate limit');
        const data1 = await res1.json();
        const items1 = data1.data || [];

        // Render first 3 immediately (Keep rest skeletons)
        let html = items1.map(m => createCardHtml(m)).join('');
        // Append remaining skeletons (e.g. 7 more)
        html += Array(7).fill('<div class="skeleton-card"></div>').join('');
        carousel.innerHTML = html;

        // RATE LIMIT PAUSE - MangaDex has better rate limits (5/sec vs Jikan's 3/sec)
        await new Promise(r => setTimeout(r, 600));

        // FETCH: Batch 2 (Next 22 - Slower)
        const res2 = await fetch(`${API_BASE_URL || ''}/api/mangadex/manga?includedTags[]=${tagId}&limit=25&order[followedCount]=desc&contentRating[]=safe&contentRating[]=suggestive&contentRating[]=erotica&contentRating[]=pornographic&includes[]=cover_art`);
        if (res2.status === 429) throw new Error('Rate limit');
        const data2 = await res2.json();
        const itemsFull = data2.data || [];

        renderCarouselItems(carousel, itemsFull);

        // CACHE SAVE
        localStorage.setItem(cacheKey, JSON.stringify({ ts: Date.now(), data: itemsFull }));

        // RATE LIMIT PAUSE (Before next genre)
        await new Promise(r => setTimeout(r, 600));

      } catch (e) {
        console.error(e);
        // On error, if we have partial data, keep it. If skeletons, show error?
        // Just leave skeletons or partials for now to avoid ugly error text.
      }
    }

    function renderCarouselItems(container, items) {
      container.innerHTML = items.map(m => createCardHtml(m)).join('');
    }

    function createCardHtml(m) {
      // Helper to build manga object for selectManga from MangaDex data
      const title = getMangaTitle(m);
      const coverUrl = buildCoverUrl(m);
      const isNSFW = m.attributes?.contentRating === 'pornographic';
      const titleStyle = isNSFW ? 'style="color: var(--blush);"' : '';
      // Escape data for onclick attribute
      const mangaJson = JSON.stringify(m).replace(/"/g, '&quot;');
      return `<div class="genre-card" onclick='selectManga(${mangaJson})'><img src="${coverUrl}" loading="lazy"><div class="genre-card-title" ${titleStyle}>${escHtml(title)}</div></div>`;
    }

    function showNotif(msg, type = '') {
      const el = document.createElement('div');
      el.className = `notif ${type}`;
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 3000);
    }

    // Lightbox
    function openLightbox(idx) {
      lightboxImg.src = state.covers[idx].url;
      lightbox.classList.add('open');
    }
    lightboxClose.onclick = () => lightbox.classList.remove('open');

    loadGenres();
    showNotif(tsunLine('onLoad'), 'blush');
  </script>
</body>

</html>